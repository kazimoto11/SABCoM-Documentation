

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Modules &mdash; SABCoM September, 2020 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Feedback" href="feedback.html" />
    <link rel="prev" title="Usage" href="usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> SABCoM
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">GETTING STARTED:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Inputs.html">Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#agent">Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#differential-equation-model">Differential equation model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment">Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#estimation">Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#helpers">Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#runner">Runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updater">Updater</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="feedback.html">Feedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="License.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SABCoM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Modules</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/modules.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="modules">
<h1>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h1>
<div class="section" id="agent">
<h2>Agent<a class="headerlink" href="#agent" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">district</span><span class="p">,</span> <span class="n">age_group</span><span class="p">,</span>
                <span class="n">informality</span><span class="p">,</span> <span class="n">number_contacts</span><span class="p">,</span> <span class="n">district_to_travel_to</span><span class="p">,</span> <span class="n">compliance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method initialises an agent and its properties.</span>
<span class="sd">        Agents have several properties, that can either be state variables (if they change),</span>
<span class="sd">        or static parameters. There is a distinction between agent specific parameters</span>
<span class="sd">        and parameters that are the same for all agents and could thus be seen</span>
<span class="sd">        as global parameters.</span>
<span class="sd">        The following inputs are used to initialise the agent</span>
<span class="sd">        :param name: unique agent identifier , integer</span>
<span class="sd">        :param status: initial disease status, string</span>
<span class="sd">        :param coordinates: the geographical coordinates of where the agent lives, tuple (float, float)</span>
<span class="sd">        :param district: the unique code / identifier of the district, int</span>
<span class="sd">        :param age_group: the age group of the agent, float ([age_0_10&#39;, &#39;age_10_20&#39;, &#39;age_20_30&#39;, &#39;age_30_40&#39;, &#39;age_40_50&#39;,</span>
<span class="sd">              &#39;age_50_60&#39;, &#39;age_60_70&#39;, &#39;age_70_80&#39;, &#39;age_80_plus&#39;)</span>
<span class="sd">        :param informality: a percentage indicating how &#39;informal&#39; the district the agent lives in is, float (0,1)</span>
<span class="sd">        :param number_contacts: the amount of trips the agent will undertake on a daily basis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># state variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># agent specific parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">district</span> <span class="o">=</span> <span class="n">district</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_group</span> <span class="o">=</span> <span class="n">age_group</span>

        <span class="c1"># agent specific variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="n">compliance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_compliance</span> <span class="o">=</span> <span class="n">compliance</span>

        <span class="c1"># implementation variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sick_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asymptomatic_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incubation_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critical_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposed_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days_recovered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">others_infected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">others_infects_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">travel_neighbours</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period_to_become_infected</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># implementation parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_contacts</span> <span class="o">=</span> <span class="n">number_contacts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">household_number</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># agent specific parameters that depend on other parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">district_to_travel_to</span> <span class="o">=</span> <span class="n">district_to_travel_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">informality</span> <span class="o">=</span> <span class="n">informality</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: String representation of the trader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s1">&#39; Agent&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="differential-equation-model">
<h2>Differential equation model<a class="headerlink" href="#differential-equation-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">differential_equations_model</span><span class="p">(</span><span class="n">compartments</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">infection_rate</span><span class="p">,</span> <span class="n">contact_probability_matrix</span><span class="p">,</span>
                                <span class="n">exit_rate_exposed</span><span class="p">,</span> <span class="n">exit_rate_asymptomatic</span><span class="p">,</span>
                                <span class="n">exit_rate_symptomatic</span><span class="p">,</span> <span class="n">exit_rate_critical</span><span class="p">,</span>
                                <span class="n">probability_symptomatic</span><span class="p">,</span> <span class="n">probability_critical</span><span class="p">,</span> <span class="n">probability_to_die</span><span class="p">,</span> <span class="n">hospital_capacity</span><span class="p">):</span>
    <span class="c1"># reshape 63 element vector Z into [7 x 9] matrix</span>
    <span class="n">compartments</span> <span class="o">=</span> <span class="n">compartments</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># assign rows to disease compartments</span>
    <span class="n">susceptible</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">asymptomatic</span><span class="p">,</span> <span class="n">symptomatic</span><span class="p">,</span> <span class="n">critical</span><span class="p">,</span> <span class="n">recovered</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">compartments</span>

    <span class="n">health_overburdened_multiplier</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># health system can be overburdened which will increase the probability of death</span>
    <span class="k">if</span> <span class="n">critical</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">hospital_capacity</span><span class="p">:</span>
        <span class="n">health_overburdened_multiplier</span> <span class="o">=</span> <span class="mf">1.79</span> <span class="c1">#TODO add this as a parameter</span>
        <span class="n">probability_to_die</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">health_overburdened_multiplier</span> <span class="o">*</span> <span class="n">probability_to_die</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="c1"># print(t)</span>

    <span class="c1"># construct differential equation evolution equations</span>
    <span class="n">delta_susceptible</span> <span class="o">=</span> <span class="o">-</span><span class="n">infection_rate</span> <span class="o">*</span> <span class="n">susceptible</span> <span class="o">*</span> <span class="n">contact_probability_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">asymptomatic</span> <span class="o">+</span> <span class="n">symptomatic</span><span class="p">))</span>
    <span class="n">delta_exposed</span> <span class="o">=</span> <span class="n">infection_rate</span> <span class="o">*</span> <span class="n">susceptible</span> <span class="o">*</span> <span class="n">contact_probability_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span>
            <span class="n">asymptomatic</span> <span class="o">+</span> <span class="n">symptomatic</span><span class="p">))</span> <span class="o">-</span> <span class="n">exit_rate_exposed</span> <span class="o">*</span> <span class="n">exposed</span>
    <span class="n">delta_asymptomatic</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability_symptomatic</span>
                          <span class="p">)</span> <span class="o">*</span> <span class="n">exit_rate_exposed</span> <span class="o">*</span> <span class="n">exposed</span> <span class="o">-</span> <span class="n">exit_rate_asymptomatic</span> <span class="o">*</span> <span class="n">asymptomatic</span>
    <span class="n">delta_symptomatic</span> <span class="o">=</span> <span class="n">probability_symptomatic</span> <span class="o">*</span> <span class="n">exit_rate_exposed</span> <span class="o">*</span> <span class="n">exposed</span> <span class="o">-</span> <span class="n">exit_rate_symptomatic</span> <span class="o">*</span> <span class="n">symptomatic</span>
    <span class="n">delta_critical</span> <span class="o">=</span> <span class="n">probability_critical</span> <span class="o">*</span> <span class="n">exit_rate_symptomatic</span> <span class="o">*</span> <span class="n">symptomatic</span> <span class="o">-</span> <span class="n">exit_rate_critical</span> <span class="o">*</span> <span class="n">critical</span>
    <span class="n">delta_recovered</span> <span class="o">=</span> <span class="n">exit_rate_asymptomatic</span> <span class="o">*</span> <span class="n">asymptomatic</span> <span class="o">+</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">probability_critical</span><span class="p">)</span> <span class="o">*</span> <span class="n">exit_rate_symptomatic</span> <span class="o">*</span> <span class="n">symptomatic</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability_to_die</span>
                                                                              <span class="p">)</span> <span class="o">*</span> <span class="n">exit_rate_critical</span> <span class="o">*</span> <span class="n">critical</span>
    <span class="n">delta_dead</span> <span class="o">=</span> <span class="n">probability_to_die</span> <span class="o">*</span> <span class="n">exit_rate_critical</span> <span class="o">*</span> <span class="n">critical</span>

    <span class="c1"># store differentials as 63 element vector</span>
    <span class="n">delta_compartments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">delta_susceptible</span><span class="p">,</span> <span class="n">delta_exposed</span><span class="p">,</span> <span class="n">delta_asymptomatic</span><span class="p">,</span>
                                        <span class="n">delta_symptomatic</span><span class="p">,</span> <span class="n">delta_critical</span><span class="p">,</span> <span class="n">delta_recovered</span><span class="p">,</span> <span class="n">delta_dead</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">delta_compartments</span>
</pre></div>
</div>
</div>
<div class="section" id="environment">
<h2>Environment<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="kn">from</span> <span class="nn">sabcom.agent</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">sabcom.helpers</span> <span class="kn">import</span> <span class="n">what_informality</span>

<span class="k">class</span> <span class="nc">Environment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The environment class contains the agents in a network structure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">district_data</span><span class="p">,</span> <span class="n">age_distribution_per_district</span><span class="p">,</span>
                <span class="n">household_contact_matrix</span><span class="p">,</span> <span class="n">other_contact_matrix</span><span class="p">,</span> <span class="n">household_size_distribution</span><span class="p">,</span> <span class="n">travel_matrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method initialises the environment and its properties.</span>
<span class="sd">        :param seed: used to initialise the random generators to ensure reproducibility, int</span>
<span class="sd">        :param parameters: contains all model parameters, dictionary</span>
<span class="sd">        :param district_data: contains empirical data on the districts, list of tuples</span>
<span class="sd">        :param age_distribution_per_district: contains the distribution across age categories per district, dictionary</span>
<span class="sd">        :param household_contact_matrix: contains number and age groups for household contacts, Pandas DataFrame</span>
<span class="sd">        :param other_contact_matrix: contains number and age groups for all other contacts, Pandas DataFrame</span>
<span class="sd">        :param household_size_distribution: contains distribution of household size for all districts, Pandas DataFrame</span>
<span class="sd">        :param travel_matrix: contains number and age groups for all other contacts, Pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_contact_matrix</span> <span class="o">=</span> <span class="n">other_contact_matrix</span>

        <span class="c1"># 1 create modelled districts</span>
        <span class="c1"># 1.1 retrieve population data</span>
        <span class="n">nbd_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">district_data</span><span class="p">]</span>
        <span class="n">population_per_neighbourhood</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Population&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbd_values</span><span class="p">]</span>

        <span class="c1"># 1.2 correct the population in districts to be proportional to number of agents</span>
        <span class="n">correction_factor</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">population_per_neighbourhood</span><span class="p">)</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;number_of_agents&quot;</span><span class="p">]</span>
        <span class="n">corrected_populations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">correction_factor</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">population_per_neighbourhood</span><span class="p">]</span>

        <span class="c1"># 1.3 only count districts that then have an amount of people bigger than 0</span>
        <span class="n">indices_big_neighbourhoods</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corrected_populations</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">corrected_populations_final</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corrected_populations</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 1.4 create a shock generator for the initialisation of agents initial compliance</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;private_shock_stdev&#39;</span><span class="p">]</span>
        <span class="n">shocks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">lower</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                                   <span class="n">size</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">corrected_populations_final</span><span class="p">))</span>

        <span class="c1"># 1.5 fill up the districts with agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">districts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">district_data</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">district_agents</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">districts</span><span class="p">}</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">city_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">all_travel_districts</span> <span class="o">=</span> <span class="p">{</span><span class="n">district_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices_big_neighbourhoods</span><span class="p">}</span>

        <span class="c1"># for every district</span>
        <span class="k">for</span> <span class="n">num_agents</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">corrected_populations_final</span><span class="p">,</span> <span class="n">indices_big_neighbourhoods</span><span class="p">):</span>
            <span class="c1"># 1.5.1 determine district code, informality, and age categories</span>
            <span class="n">district_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">district_code</span> <span class="o">=</span> <span class="n">district_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">informality</span> <span class="o">=</span> <span class="n">what_informality</span><span class="p">(</span><span class="n">district_code</span><span class="p">,</span> <span class="n">district_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;informality_dummy&quot;</span><span class="p">]</span>

            <span class="n">age_categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">age_distribution_per_district</span><span class="p">[</span><span class="n">district_code</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                              <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">num_agents</span><span class="p">),</span>
                                              <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">p</span><span class="o">=</span><span class="n">age_distribution_per_district</span><span class="p">[</span><span class="n">district_code</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># 1.5.2 determine districts to travel to</span>
            <span class="n">available_districts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_travel_districts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">travel_matrix</span><span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">available_districts</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">district_code</span><span class="p">])</span>

            <span class="c1"># 1.5.3 add agents to district</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_agents</span><span class="p">):</span>
                <span class="n">init_private_signal</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">shocks</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>
                <span class="n">district_to_travel_to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_districts</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
                              <span class="n">district_code</span><span class="p">,</span>
                              <span class="n">age_categories</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
                              <span class="n">informality</span><span class="p">,</span>
                              <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">other_contact_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">age_categories</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">())),</span>
                              <span class="n">district_to_travel_to</span><span class="p">,</span>
                              <span class="n">init_private_signal</span>
                              <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">district_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                <span class="n">district_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                <span class="n">all_travel_districts</span><span class="p">[</span><span class="n">district_to_travel_to</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                <span class="n">agent_name</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># 2 Create the household network structure</span>
            <span class="c1"># 2.1 get household size list for this Ward and reduce list to max household size = size of ward</span>
            <span class="n">max_district_household</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">household_size_distribution</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">hh_sizes</span> <span class="o">=</span> <span class="n">household_size_distribution</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">district_code</span><span class="p">][:</span><span class="n">max_district_household</span><span class="p">]</span>
            <span class="c1"># 2.2 then calculate probabilities of this being of a certain size</span>
            <span class="n">hh_probability</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hh_sizes</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hh_sizes</span><span class="p">])</span>
            <span class="n">hh_probability</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">hh_sizes</span><span class="o">.</span><span class="n">index</span>
            <span class="c1"># 2.3 determine household sizes</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">):</span>
                <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">hh_probability</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">hh_probability</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">hh_probability</span> <span class="o">=</span> <span class="n">hh_probability</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)]</span>
                <span class="c1"># recalculate probabilities</span>
                <span class="n">hh_probability</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hh_probability</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hh_probability</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hh_probability</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">hh_sizes</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error occured&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lenght of district list = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sum(sizes) = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hh_sizes.index[:len(district_list) - sum(sizes)]is &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hh_sizes</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">district_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hh_probability.index = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hh_probability</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="c1"># 2.4 Distribute agents over households</span>
            <span class="c1"># 2.4.1 pick the household heads and let it form connections with other based on probabilities.</span>
            <span class="c1"># household heads are chosen at random without replacement</span>
            <span class="n">household_heads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">district_list</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">not_household_heads</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">district_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">household_heads</span><span class="p">]</span>
            <span class="c1"># 2.4.2 let the household heads pick n other agents that are not household heads themselves</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">head</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">household_heads</span><span class="p">):</span>
                <span class="n">head</span><span class="o">.</span><span class="n">household_number</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># pick n other agents based on probability given their age</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">household_contact_matrix</span><span class="p">[</span><span class="n">to</span><span class="o">.</span><span class="n">age_group</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">head</span><span class="o">.</span><span class="n">age_group</span><span class="p">]</span> <span class="k">for</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">not_household_heads</span><span class="p">]</span>
                    <span class="c1"># normalize p</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
                    <span class="n">household_members</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">not_household_heads</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>

                    <span class="c1"># remove household members from not_household_heads</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">household_members</span><span class="p">:</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">household_number</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">not_household_heads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

                    <span class="c1"># add head to household members:</span>
                    <span class="n">household_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">household_members</span> <span class="o">=</span> <span class="p">[</span><span class="n">head</span><span class="p">]</span>

                <span class="c1"># 2.4.3 create graph for household</span>
                <span class="n">household_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
                <span class="n">household_graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">household_members</span><span class="p">)))</span>

                <span class="c1"># create edges between all household members</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">complete_graph</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">household_members</span><span class="p">))</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
                <span class="n">household_graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;household&#39;</span><span class="p">)</span>

                <span class="c1"># add household members to the agent list</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">household_members</span><span class="p">)</span>

                <span class="c1"># 2.4.4 add network to city graph</span>
                <span class="n">city_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">disjoint_union</span><span class="p">(</span><span class="n">city_graph</span><span class="p">,</span> <span class="n">household_graph</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># 3 Next, we create the a city wide network structure of recurring contacts based on the travel matrix</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agents_to_travel_to</span> <span class="o">=</span> <span class="n">all_travel_districts</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">district_to_travel_to</span><span class="p">]</span>
            <span class="n">agents_to_travel_to</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>  <span class="c1"># remove the agent itself</span>

            <span class="k">if</span> <span class="n">agents_to_travel_to</span><span class="p">:</span>
                <span class="c1"># select the agents which it is most likely to have contact with based on the travel matrix</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">other_contact_matrix</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">age_group</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">age_group</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">agents_to_travel_to</span><span class="p">]</span>
                <span class="c1"># normalize p</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>

                <span class="n">location_closest_agents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">agents_to_travel_to</span><span class="p">,</span>
                                                          <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">num_contacts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents_to_travel_to</span><span class="p">)),</span>
                                                          <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                          <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ca</span> <span class="ow">in</span> <span class="n">location_closest_agents</span><span class="p">:</span>
                    <span class="n">city_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">city_graph</span>

        <span class="c1"># 4 rename agents to reflect their new position</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># 5 add agent to the network structure</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">infection_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infection_quantities</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;compliance&#39;</span><span class="p">]}</span>

        <span class="c1"># 6 add stringency index from parameters to reflect how strict regulations are enforced</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">]),</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])]</span>

    <span class="k">def</span> <span class="nf">store_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a deep copy of the current network&quot;&quot;&quot;</span>
        <span class="n">current_network</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_network</span>

    <span class="k">def</span> <span class="nf">write_status_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">base_folder</span><span class="o">=</span><span class="s1">&#39;measurement/&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes information about the agents and their status in the current period to a csv file</span>
<span class="sd">        :param period: the current time period, int</span>
<span class="sd">        :param seed: used to initialise the random generators to ensure reproducibility, int</span>
<span class="sd">        :param base_folder: the location of the folder to write the csv to, string</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">location_status_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;WardID&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;age_group&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="s1">&#39;others_infected&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;compliance&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;WardID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">district</span><span class="p">)</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">age_group</span><span class="p">)</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;others_infected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">others_infected</span><span class="p">)</span>
            <span class="n">location_status_data</span><span class="p">[</span><span class="s1">&#39;compliance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">compliance</span><span class="p">)</span>

        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">location_status_data</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s2">&quot;seed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/agent_data</span><span class="si">{0:04}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">period</span><span class="p">))</span>

        <span class="c1"># output links</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s2">&quot;seed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/edge_list</span><span class="si">{0:04}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">period</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="estimation">
<h2>Estimation<a class="headerlink" href="#estimation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sciopt</span>

<span class="kn">from</span> <span class="nn">sabcom.updater</span> <span class="kn">import</span> <span class="n">updater</span>

 <span class="k">def</span> <span class="nf">ls_model_performance</span><span class="p">(</span><span class="n">input_params</span><span class="p">,</span> <span class="n">input_folder_path</span><span class="p">,</span> <span class="n">mc_runs</span><span class="p">,</span> <span class="n">output_folder_path</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple function calibrate uncertain model parameters</span>
<span class="sd">    :param input_parameters: list of input parameters</span>
<span class="sd">    :return: cost</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># zip names and input params together in a dictionary</span>
    <span class="c1">#new_params = {name: par for name, par in zip(names, input_params)}</span>

    <span class="c1"># transmission_probability = input_params[0]</span>
    <span class="c1"># initial_infections = input_params[1]</span>
    <span class="c1"># infection_multiplier = input_params[2]</span>
    <span class="c1"># base_awareness_likelihood = input_params[3]</span>
    <span class="c1"># gathering_max_contacts = input_params[4]</span>

    <span class="n">parameter_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s1">&#39;parameters.json&#39;</span><span class="p">)</span>
    <span class="n">mc_runs</span> <span class="o">=</span> <span class="n">mc_runs</span>

    <span class="c1"># open estimation_parameter.json file to extract special parameters used for the estimation</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_json_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="n">param_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

    <span class="n">emp_fatality_curve</span> <span class="o">=</span> <span class="n">param_file</span><span class="p">[</span><span class="s1">&#39;empirical_fatalities&#39;</span><span class="p">]</span>
    <span class="n">empirical_population</span> <span class="o">=</span> <span class="n">param_file</span><span class="p">[</span><span class="s1">&#39;empirical_population&#39;</span><span class="p">]</span>
    <span class="c1"># new!</span>
    <span class="c1"># param_file[&#39;private_shock_stdev&#39;] = input_params[5]</span>
    <span class="c1"># param_file[&#39;weight_private_signal&#39;] = input_params[6]</span>
    <span class="c1"># # change all of them</span>
    <span class="c1"># param_file[&#39;probability_transmission&#39;] = transmission_probability</span>
    <span class="c1"># param_file[&quot;physical_distancing_multiplier&quot;] = infection_multiplier</span>
    <span class="c1"># param_file[&#39;likelihood_awareness&#39;] = base_awareness_likelihood</span>
    <span class="c1"># param_file[&quot;gathering_max_contacts&quot;] = gathering_max_contacts</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">input_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;total_initial_infections&#39;</span><span class="p">]:</span>
            <span class="n">param_file</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">:</span>
            <span class="n">vis_rec</span> <span class="o">=</span> <span class="n">par</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vis_rec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;total_initial_infections&#39;</span><span class="p">:</span>
            <span class="n">initial_infections</span> <span class="o">=</span> <span class="n">par</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vis_rec</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">param_file</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emp_fatality_curve</span><span class="p">)</span>

    <span class="c1"># dump in config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;estimation_parameters.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">param_file</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mc_runs</span><span class="p">):</span>
        <span class="c1"># check if the seed can be found in the input folder, if not skip seed</span>
        <span class="n">inititialisation_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s1">&#39;initialisations&#39;</span><span class="p">)</span>
        <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inititialisation_path</span><span class="p">,</span> <span class="s1">&#39;seed_</span><span class="si">{}</span><span class="s1">.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_path</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Path </span><span class="si">{}</span><span class="s1"> not found, will continue loop&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_path</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># run model with parameters.</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="n">updater</span><span class="p">(</span><span class="n">input_folder_path</span><span class="o">=</span><span class="n">input_folder_path</span><span class="p">,</span>
                              <span class="n">output_folder_path</span><span class="o">=</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                              <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
                              <span class="n">initial_infections</span><span class="o">=</span><span class="n">initial_infections</span><span class="p">,</span>
                              <span class="n">visiting_recurring_contacts_multiplier</span><span class="o">=</span><span class="n">vis_rec</span><span class="p">,</span>
                              <span class="n">stringency_changed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">sensitivity_config_file_path</span><span class="o">=</span><span class="s1">&#39;estimation_parameters.json&#39;</span><span class="p">)</span>

        <span class="n">sim_dead_curve</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">infection_quantities</span><span class="p">)[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">empirical_population</span> <span class="o">/</span> <span class="n">param_file</span><span class="p">[</span><span class="s1">&#39;number_of_agents&#39;</span><span class="p">])</span>
        <span class="n">sim_dead_curve</span> <span class="o">=</span> <span class="n">sim_dead_curve</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># calculate the cost</span>
        <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ls_cost_function</span><span class="p">(</span><span class="n">emp_fatality_curve</span><span class="p">,</span> <span class="n">sim_dead_curve</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">confidence_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">av</span><span class="p">):</span>
  <span class="n">sample_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">sigma</span> <span class="o">=</span> <span class="n">sample_stdev</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">av</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

 <span class="k">def</span> <span class="nf">ls_cost_function</span><span class="p">(</span><span class="n">observed_values</span><span class="p">,</span> <span class="n">average_simulated_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple cost function to calculate average squared deviation of simulated values from observed values</span>
<span class="sd">    :param observed_values: list of observed data points</span>
<span class="sd">    :param average_simulated_values: list of corresponding observed data points</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">observed_values</span><span class="p">,</span> <span class="n">average_simulated_values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">score</span>

<span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">observed_values</span><span class="p">,</span> <span class="n">average_simulated_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple cost function to calculate average squared deviation of simulated values from observed values</span>
<span class="sd">    :param observed_values: dictionary of observed stylized facts</span>
<span class="sd">    :param average_simulated_values: dictionary of corresponding simulated stylized facts</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">observed_values</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">((</span><span class="n">observed_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">average_simulated_values</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">observed_values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">score</span>


<span class="c1"># =====================================================================================================================================</span>
<span class="c1"># Copyright</span>
<span class="c1"># =====================================================================================================================================</span>

<span class="c1"># Copyright (C) 2017 Alexander Blaessle.</span>
<span class="c1"># This software is distributed under the terms of the GNU General Public License.</span>

<span class="c1"># This file is part of constNMPY.</span>

<span class="c1"># constNMPy is a small python package allowing to run a Nelder-Mead optimization via scipy&#39;s fmin function.</span>

<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="c1"># ===========================================================================================================================================================================</span>
<span class="c1"># Module Functions</span>
<span class="c1"># ===========================================================================================================================================================================</span>

<span class="k">def</span> <span class="nf">constrNM</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxfun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">retall</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constrained Nelder-Mead optimizer.</span>
<span class="sd">    Transforms a constrained problem</span>
<span class="sd">    Args:</span>
<span class="sd">        func (function): Objective function.</span>
<span class="sd">        x0 (numpy.ndarray): Initial guess.</span>
<span class="sd">        LB (numpy.ndarray): Lower bounds.</span>
<span class="sd">        UB (numpy.ndarray): Upper bounds.</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        args (tuple): Extra arguments passed to func, i.e. ``func(x,*args).``</span>
<span class="sd">        xtol (float) :Absolute error in xopt between iterations that is acceptable for convergence.</span>
<span class="sd">        ftol(float) : Absolute error in ``func(xopt)`` between iterations that is acceptable for convergence.</span>
<span class="sd">        maxiter(int) : Maximum number of iterations to perform.</span>
<span class="sd">        maxfun(int) : Maximum number of function evaluations to make.</span>
<span class="sd">        full_output(bool) : Set to True if fopt and warnflag outputs are desired.</span>
<span class="sd">        disp(bool) : Set to True to print convergence messages.</span>
<span class="sd">        retall(bool): Set to True to return list of solutions at each iteration.</span>
<span class="sd">        callback(callable) : Called after each iteration, as ``callback(xk)``, where xk is the current parameter vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check input</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">LB</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">UB</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">LB</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input arrays have unequal size.&#39;</span><span class="p">)</span>

    <span class="c1"># Check if x0 is within bounds</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x0</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">errStr</span> <span class="o">=</span> <span class="s1">&#39;Initial guess x0[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of bounds.&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errStr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">errStr</span> <span class="o">=</span> <span class="s1">&#39;Initial guess x0[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of bounds.&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errStr</span><span class="p">)</span>

    <span class="c1"># Transform x0</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">transformX0</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">)</span>

    <span class="c1"># Stick everything into args tuple</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">func</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="n">args</span><span class="p">])</span>

    <span class="c1"># Call fmin</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">constrObjFunc</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="n">ftol</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">,</span>
                      <span class="n">full_output</span><span class="o">=</span><span class="n">full_output</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">maxfun</span><span class="o">=</span><span class="n">maxfun</span><span class="p">,</span> <span class="n">retall</span><span class="o">=</span><span class="n">retall</span><span class="p">)</span>

    <span class="c1"># Convert res to list</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># Dictionary for results</span>
    <span class="n">rDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fopt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;funcalls&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;warnflag&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;xopt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;allvecs&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># Transform back results</span>
    <span class="k">if</span> <span class="n">full_output</span> <span class="ow">or</span> <span class="n">retall</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">transformX</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">transformX</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">)</span>
    <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;xopt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

    <span class="c1"># If full_output is selected, enter all results in dict</span>
    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;fopt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;funcalls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;warnflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># If retall is selected, transform back all values and append to dict</span>
    <span class="k">if</span> <span class="n">retall</span><span class="p">:</span>
        <span class="n">allvecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">allvecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transformX</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">))</span>
        <span class="n">rDict</span><span class="p">[</span><span class="s1">&#39;allvecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allvecs</span>

    <span class="k">return</span> <span class="n">rDict</span>

<span class="k">def</span> <span class="nf">constrObjFunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Objective function when using Constrained Nelder-Mead.</span>
<span class="sd">    Calls :py:func:`TransformX` to transform ``x`` into</span>
<span class="sd">    constrained version, then calls objective function ``func``.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (numpy.ndarray): Input vector.</span>
<span class="sd">        func (function): Objective function.</span>
<span class="sd">        LB (numpy.ndarray): Lower bounds.</span>
<span class="sd">        UB (numpy.ndarray): Upper bounds.</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        args (tuple): Extra arguments passed to func, i.e. ``func(x,*args).``</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: Return value of ``func(x,*args)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># print x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">transformX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">)</span>
    <span class="c1"># print x</span>
    <span class="c1"># raw_input()</span>

    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">transformX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">1E-20</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Transforms ``x`` into constrained form, obeying upper bounds ``UB`` and lower bounds ``LB``.</span>
<span class="sd">    .. note:: Will add tiny offset to LB if ``LB[i]=0``, to avoid singularities.</span>
<span class="sd">    Idea taken from http://www.mathworks.com/matlabcentral/fileexchange/8277-fminsearchbnd--fminsearchcon</span>
<span class="sd">    Args:</span>
<span class="sd">        x (numpy.ndarray): Input vector.</span>
<span class="sd">        LB (numpy.ndarray): Lower bounds.</span>
<span class="sd">        UB (numpy.ndarray): Upper bounds.</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        offset (float): Small offset added to lower bound if LB=0.</span>
<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Transformed x-values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure everything is float</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1"># LB=np.asarray(LB,dtype=np.float64)</span>
    <span class="c1"># UB=np.asarray(UB,dtype=np.float64)</span>

    <span class="c1"># Add offset if necessary to avoid singularities</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">LB</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="c1"># Determine number of parameters to be fitted</span>
    <span class="n">nparams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Make empty vector</span>
    <span class="n">xtrans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># k allows some variables to be fixed, thus dropped from the</span>
    <span class="c1"># optimization.</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparams</span><span class="p">):</span>

        <span class="c1"># Upper bound only</span>
        <span class="k">if</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Lower bound only</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Both bounds</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">min</span><span class="p">([</span><span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]])])</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># No bounds</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># NOTE: The original file has here another case for fixed variable. We might need to add this here!!!</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xtrans</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">transformX0</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Transforms ``x0`` into constrained form, obeying upper bounds ``UB`` and lower bounds ``LB``.</span>
<span class="sd">    Idea taken from http://www.mathworks.com/matlabcentral/fileexchange/8277-fminsearchbnd--fminsearchcon</span>
<span class="sd">    Args:</span>
<span class="sd">        x0 (numpy.ndarray): Input vector.</span>
<span class="sd">        LB (numpy.ndarray): Lower bounds.</span>
<span class="sd">        UB (numpy.ndarray): Upper bounds.</span>
<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Transformed x-values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Turn into list</span>
    <span class="n">x0u</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)):</span>

        <span class="c1"># Upper bound only</span>
        <span class="k">if</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Lower bound only</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>


        <span class="c1"># Both bounds</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                <span class="c1"># shift by 2*pi to avoid problems at zero in fmin otherwise, the initial simplex is vanishingly small</span>
                <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">])]));</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># No bounds</span>
        <span class="k">elif</span> <span class="n">UB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">LB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0u</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">printAttr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">maxL</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints single attribute in the form attributeName = attributeValue.</span>
<span class="sd">    If attributes are of type ``list`` or ``numpy.ndarray``, will check if the size</span>
<span class="sd">    exceeds threshold. If so, will only print type and dimension of attribute.</span>
<span class="sd">    Args:</span>
<span class="sd">        name (str): Name of attribute.</span>
<span class="sd">        attr (any): Attribute value.</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        maxL (int): Maximum length threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxL</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; = &quot;</span><span class="p">,</span> <span class="n">getListDetailsString</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxL</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; = &quot;</span><span class="p">,</span> <span class="n">getArrayDetailsString</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; = &quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">getListDetailsString</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns string saying &quot;List of length x&quot;, where x is the length of the list.</span>
<span class="sd">    Args:</span>
<span class="sd">        l (list): Some list.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Printout of type and length.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;List of length &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">getArrayDetailsString</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns string saying &quot;Array of shape x&quot;, where x is the shape of the array.</span>
<span class="sd">    Args:</span>
<span class="sd">        l (numpy.ndarray): Some array.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Printout of type and shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;Array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">printDict</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">maxL</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints all dictionary entries in the form key = value.</span>
<span class="sd">    If attributes are of type ``list`` or ``numpy.ndarray``, will check if the size</span>
<span class="sd">    exceeds threshold. If so, will only print type and dimension of attribute.</span>
<span class="sd">    Args:</span>
<span class="sd">        dic (dict): Dictionary to be printed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">printAttr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">maxL</span><span class="o">=</span><span class="n">maxL</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="helpers">
<h2>Helpers<a class="headerlink" href="#helpers" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>


<span class="k">def</span> <span class="nf">edge_in_cliq</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">nodes_in_cliq</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nodes_in_cliq</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">edges_to_remove_neighbourhood</span><span class="p">(</span><span class="n">all_edges</span><span class="p">,</span> <span class="n">neighbourhood_density</span><span class="p">,</span> <span class="n">nbh_nodes</span><span class="p">):</span>
    <span class="n">neighbourhood_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_edges</span> <span class="k">if</span> <span class="n">edge_in_cliq</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">nbh_nodes</span><span class="p">)]</span>
    <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbourhood_edges</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">neighbourhood_density</span><span class="p">))</span>
    <span class="c1"># sample random edges</span>
    <span class="n">chosen_edges</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">neighbourhood_edges</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chosen_edges</span>


<span class="k">def</span> <span class="nf">what_neighbourhood</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">neighbourhood_nodes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbourhood_nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">neighbourhood_nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">n</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Neighbourhood not found.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">what_coordinates</span><span class="p">(</span><span class="n">neighbourhood_name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">neighbourhood_name</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Corresponding coordinates not found&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">what_informality</span><span class="p">(</span><span class="n">neighbourhood_name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">neighbourhood_name</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Corresponding informality not found&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">confidence_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">av</span><span class="p">):</span>
    <span class="n">sample_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sample_stdev</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">av</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_district_data</span><span class="p">(</span><span class="n">number_of_agents</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">max_districts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms input data on informal residential, initial infections, and population and transforms it to</span>
<span class="sd">    a list of organised data for the simulation.</span>
<span class="sd">    :param number_of_agents: number of agents in the simulation, integer</span>
<span class="sd">    :param max_districts: (optional) maximum amount of districts simulated, integer</span>
<span class="sd">    :return: data set containing district data for simulation, list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">informal_residential</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/f_informality.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="c1">#.iloc[:-1]</span>
    <span class="n">inital_infections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/f_initial_cases.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">inital_infections</span> <span class="o">=</span> <span class="n">inital_infections</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">population</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/f_population.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="c1"># normalise district informality</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">informal_residential</span><span class="p">[[</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">min_max_scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">MinMaxScaler</span><span class="p">()</span>
    <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">informal_residential</span><span class="p">[</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">)</span>
    <span class="n">population</span><span class="p">[</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">informal_residential</span><span class="p">[</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]</span>

    <span class="c1"># determine smallest district based on number of agents</span>
    <span class="n">smallest_size</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="s1">&#39;Population&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">number_of_agents</span>

    <span class="c1"># generate data set for model input</span>
    <span class="n">districts_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">population</span><span class="p">[</span><span class="s1">&#39;Population&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">smallest_size</span><span class="p">:</span>
            <span class="n">districts_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">population</span><span class="p">[</span><span class="s1">&#39;WardID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">{</span><span class="s1">&#39;Population&#39;</span><span class="p">:</span> <span class="n">population</span><span class="p">[</span><span class="s1">&#39;Population&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                    <span class="c1">#&#39;lon&#39;: population[&#39;lon&#39;].iloc[i],</span>
                                                    <span class="c1">#&#39;lat&#39;: population[&#39;lat&#39;].iloc[i],</span>
                                                    <span class="s1">&#39;Informal_residential&#39;</span><span class="p">:</span> <span class="n">population</span><span class="p">[</span><span class="s1">&#39;Informal_residential&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                    <span class="s1">&#39;Cases_With_Subdistricts&#39;</span><span class="p">:</span>
                                                        <span class="n">inital_infections</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">population</span><span class="p">[</span><span class="s1">&#39;WardID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span>
                                                            <span class="s1">&#39;Cases&#39;</span><span class="p">],</span>
                                                    <span class="p">},</span>
                <span class="p">])</span>

    <span class="k">if</span> <span class="n">max_districts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_districts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">districts_data</span><span class="p">)</span>  <span class="c1"># this can be manually shortened to study dynamics in some districts</span>

    <span class="k">return</span> <span class="n">districts_data</span><span class="p">[:</span><span class="n">max_districts</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="runner">
<h2>Runner<a class="headerlink" href="#runner" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>


<span class="k">def</span> <span class="nf">runner</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">initial_infections</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">data_folder</span><span class="o">=</span><span class="s1">&#39;output_data/&#39;</span><span class="p">,</span>
          <span class="n">data_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calculate_r_naught</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to run / simulate the model.</span>
<span class="sd">    :param environment: contains the parameters and agents, Environment object</span>
<span class="sd">    :param initial_infections: contains the Wards and corresponding initial infections, Pandas DataFrame</span>
<span class="sd">    :param seed: used to initialise the random generators to ensure reproducibility, int</span>
<span class="sd">    :param data_folder:  string of the folder where data output files should be created</span>
<span class="sd">    :param data_output:  can be &#39;csv&#39;, &#39;network&#39;, or False (for no output)</span>
<span class="sd">    :param calculate_r_naught: set to True to calculate the R0 that the model produces given a single infected agent</span>
<span class="sd">    :return: environment object containing the updated agents, Environment object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1 set monte carlo seed</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># 2 create sets for all agent types</span>
    <span class="n">dead</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">recovered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">critical</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sick_with_symptoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sick_without_symptoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">exposed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">susceptible</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
    <span class="n">compliance</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 3 Initialisation of infections</span>
    <span class="c1"># 3a infect a fixed initial agent to calculate R_0</span>
    <span class="k">if</span> <span class="n">calculate_r_naught</span><span class="p">:</span>
        <span class="n">initial_infected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chosen_agent</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_infected_agent&#39;</span><span class="p">]]</span>
        <span class="n">chosen_agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span>
        <span class="n">initial_infected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
        <span class="n">exposed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
        <span class="n">susceptible</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
    <span class="c1"># 3b the default mode is to infect a set of agents based on the locations of observed infections</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_infections</span> <span class="o">=</span> <span class="n">initial_infections</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">initial_infections</span><span class="p">[</span><span class="s1">&#39;Cases&#39;</span><span class="p">]]</span>
        <span class="n">probabilities_new_infection_district</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span>

        <span class="n">initial_infected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 3b-1 select districts with probability</span>
        <span class="n">chosen_districts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">districts</span><span class="p">,</span>
                                                <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;total_initial_infections&#39;</span><span class="p">],</span>
                                                <span class="n">p</span><span class="o">=</span><span class="n">probabilities_new_infection_district</span><span class="p">))</span>
        <span class="c1"># 3b-2 count how often a district is in that list</span>
        <span class="n">chosen_districts</span> <span class="o">=</span> <span class="p">{</span><span class="n">distr</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">distr</span><span class="p">]),</span>
                                      <span class="n">chosen_districts</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distr</span><span class="p">))</span> <span class="k">for</span> <span class="n">distr</span> <span class="ow">in</span> <span class="n">chosen_districts</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">district</span> <span class="ow">in</span> <span class="n">chosen_districts</span><span class="p">:</span>
            <span class="c1"># 3b-3 infect appropriate number of random agents</span>
            <span class="n">chosen_agents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">district</span><span class="p">],</span> <span class="n">chosen_districts</span><span class="p">[</span><span class="n">district</span><span class="p">],</span>
                                            <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">]</span>
            <span class="c1"># 3b-4 and give them a random status exposed, asymptomatic, or symptomatic with a random number of days</span>
            <span class="c1"># already passed being in that state</span>
            <span class="k">for</span> <span class="n">chosen_agent</span> <span class="ow">in</span> <span class="n">chosen_agents</span><span class="p">:</span>
                <span class="n">new_status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
                <span class="n">chosen_agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
                <span class="k">if</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
                    <span class="n">chosen_agent</span><span class="o">.</span><span class="n">incubation_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;exposed_days&#39;</span><span class="p">])</span>
                    <span class="n">exposed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;i1&#39;</span><span class="p">:</span>
                    <span class="n">chosen_agent</span><span class="o">.</span><span class="n">asymptomatic_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;asymptom_days&#39;</span><span class="p">])</span>
                    <span class="n">sick_without_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;i2&#39;</span><span class="p">:</span>
                    <span class="n">chosen_agent</span><span class="o">.</span><span class="n">sick_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;symptom_days&#39;</span><span class="p">])</span>
                    <span class="n">sick_with_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>

                <span class="n">susceptible</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>

    <span class="c1"># 4 day loop</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]):</span>
        <span class="c1"># 4.1 check if the health system is not overburdened</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">critical</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;health_system_capacity&quot;</span><span class="p">]:</span>
            <span class="n">health_overburdened_multiplier</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;no_hospital_multiplier&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">health_overburdened_multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># 4.2 create a generator to generate shocks for private signal for this period based on current stringency index</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;private_shock_stdev&#39;</span><span class="p">]</span>
        <span class="n">shocks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">lower</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">susceptible</span> <span class="o">+</span> <span class="n">exposed</span> <span class="o">+</span> <span class="n">sick_without_symptoms</span> <span class="o">+</span> <span class="n">sick_with_symptoms</span> <span class="o">+</span> <span class="n">critical</span> <span class="o">+</span> <span class="n">recovered</span><span class="p">))</span>

        <span class="c1"># 4.3 update status loop for all agents, except dead agents</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">susceptible</span> <span class="o">+</span> <span class="n">exposed</span> <span class="o">+</span> <span class="n">sick_without_symptoms</span> <span class="o">+</span> <span class="n">sick_with_symptoms</span> <span class="o">+</span> <span class="n">critical</span> <span class="o">+</span> <span class="n">recovered</span><span class="p">):</span>
            <span class="c1"># 4.3.1 save compliance to previous compliance</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">previous_compliance</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span>

            <span class="c1"># 4.3.2 calculate new compliance based on private and neighbour signal</span>
            <span class="n">neighbours_to_learn_from</span> <span class="o">=</span> <span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

            <span class="n">private_signal</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">shocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">neighbours_to_learn_from</span><span class="p">:</span>  <span class="c1"># take into account the scenario that there are no neighbours to learn from</span>
                <span class="n">neighbour_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">previous_compliance</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">neighbours_to_learn_from</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neighbour_signal</span> <span class="o">=</span> <span class="n">private_signal</span>

            <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">informality</span><span class="p">)</span> <span class="o">*</span> \
                              <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;weight_private_signal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">private_signal</span> <span class="o">+</span>
                                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;weight_private_signal&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">neighbour_signal</span><span class="p">)</span>

            <span class="c1"># 4.3.3 the disease status of the agent</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">period_to_become_infected</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span>
                <span class="n">susceptible</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                <span class="n">exposed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">exposed_days</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># some agents will become infectious but do not show agents while others will show symptoms</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">exposed_days</span> <span class="o">&gt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;exposed_days&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_symptomatic&quot;</span><span class="p">]:</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;i2&#39;</span>
                        <span class="n">exposed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="n">sick_with_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;i1&#39;</span>
                        <span class="n">exposed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="n">sick_without_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="c1"># any agent with status i1, or i2 might first infect other agents and then will update her status</span>
            <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">]:</span>
                <span class="c1"># check if the agent is aware that is is infected here and set compliance to 1.0 if so</span>
                <span class="n">likelihood_awareness</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">likelihood_awareness</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;i2&#39;</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="c1"># Infect others / TAG SUSCEPTIBLE AGENTS FOR INFECTION</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">others_infected</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># find indices from neighbour agents</span>
                <span class="n">household_neighbours</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span>
                                        <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">household_number</span> <span class="o">==</span> <span class="n">agent</span><span class="o">.</span><span class="n">household_number</span> <span class="ow">and</span>
                                        <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">district</span> <span class="o">==</span> <span class="n">agent</span><span class="o">.</span><span class="n">district</span><span class="p">]</span>
                <span class="n">other_neighbours</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span>
                                    <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">household_number</span> <span class="o">!=</span> <span class="n">agent</span><span class="o">.</span><span class="n">household_number</span> <span class="ow">or</span>
                                    <span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">district</span> <span class="o">!=</span> <span class="n">agent</span><span class="o">.</span><span class="n">district</span><span class="p">]</span>

                <span class="c1"># depending on compliance, the amount of non-household contacts an agent can visit is reduced</span>
                <span class="n">visiting_r_contacts_multiplier</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visiting_recurring_contacts_multiplier&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">compliance_term_contacts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">visiting_r_contacts_multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span><span class="p">)</span>

                <span class="c1"># step 1 planned contacts is shaped by</span>
                <span class="k">if</span> <span class="n">other_neighbours</span><span class="p">:</span>
                    <span class="n">planned_contacts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_neighbours</span>
                                                    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">visiting_r_contacts_multiplier</span> <span class="o">+</span> <span class="n">compliance_term_contacts</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">planned_contacts</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># step 2 by gathering max contacts</span>
                <span class="n">gathering_max_contacts</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gathering_max_contacts</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="n">gathering_max_contacts</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                       <span class="n">gathering_max_contacts</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))))</span>
                    <span class="n">individual_max_contacts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">gathering_max_contacts</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">individual_max_contacts</span> <span class="o">=</span> <span class="n">gathering_max_contacts</span>

                <span class="k">if</span> <span class="n">planned_contacts</span> <span class="o">&gt;</span> <span class="n">individual_max_contacts</span><span class="p">:</span>
                    <span class="n">other_neighbours</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">other_neighbours</span><span class="p">,</span> <span class="n">individual_max_contacts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_neighbours</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">other_neighbours</span><span class="p">,</span> <span class="n">planned_contacts</span><span class="p">)</span>

                <span class="c1"># step 3 combine household neighbours with other neighbours</span>
                <span class="n">neighbours_from_graph</span> <span class="o">=</span> <span class="n">household_neighbours</span> <span class="o">+</span> <span class="n">other_neighbours</span>
                <span class="c1"># step 4 find the corresponding agents and add them to a list to infect</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">neighbours_to_infect</span> <span class="o">=</span> <span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">household_neighbours</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">neighbours_to_infect</span> <span class="o">=</span> <span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">neighbours_from_graph</span><span class="p">]</span>
                <span class="c1"># step 4 let these agents be infected (with random probability</span>
                <span class="n">physical_distancing_multiplier</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;physical_distancing_multiplier&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours_to_infect</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">household_number</span> <span class="o">==</span> <span class="n">agent</span><span class="o">.</span><span class="n">household_number</span> <span class="ow">and</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">district</span> <span class="o">==</span> <span class="n">agent</span><span class="o">.</span><span class="n">district</span><span class="p">:</span>
                        <span class="n">compliance_term_phys_dis</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># (1 - physical_distancing_multiplier)</span>
                        <span class="n">compliance_term_phys_dis_neighbour</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compliance_term_phys_dis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">physical_distancing_multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span><span class="p">)</span>
                        <span class="n">compliance_term_phys_dis_neighbour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">physical_distancing_multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="mi">1</span> <span class="o">-</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">compliance</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span>
                            <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">physical_distancing_multiplier</span> <span class="o">+</span> <span class="n">compliance_term_phys_dis</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">physical_distancing_multiplier</span> <span class="o">+</span> <span class="n">compliance_term_phys_dis_neighbour</span><span class="p">)):</span>
                        <span class="n">neighbour</span><span class="o">.</span><span class="n">period_to_become_infected</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">others_infected</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># update current status based on category</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;i1&#39;</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">asymptomatic_days</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># asymptomatic agents all recover after some time</span>
                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">asymptomatic_days</span> <span class="o">&gt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;asymptom_days&quot;</span><span class="p">]:</span>
                        <span class="c1"># calculate R0 here if the first agent recovers</span>
                        <span class="k">if</span> <span class="n">calculate_r_naught</span> <span class="ow">and</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">initial_infected</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39; patient zero recovered or dead with R0 = &#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span>

                        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                        <span class="n">sick_without_symptoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="n">recovered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;i2&#39;</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">sick_days</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># some symptomatic agents recover</span>
                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">sick_days</span> <span class="o">&gt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;symptom_days&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_critical&quot;</span><span class="p">][</span><span class="n">agent</span><span class="o">.</span><span class="n">age_group</span><span class="p">]:</span>
                            <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
                            <span class="n">sick_with_symptoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                            <span class="n">critical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># calculate R0 here if the first agent recovers</span>
                            <span class="k">if</span> <span class="n">calculate_r_naught</span> <span class="ow">and</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">initial_infected</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39; patient zero recovered or dead with R0 = &#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span>
                            <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                            <span class="n">sick_with_symptoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                            <span class="n">recovered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">critical_days</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># some agents in critical status will die, the rest will recover</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">critical_days</span> <span class="o">&gt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;critical_days&quot;</span><span class="p">]:</span>
                    <span class="c1"># calculate R0 here if the first agent recovers or dies</span>
                    <span class="k">if</span> <span class="n">calculate_r_naught</span> <span class="ow">and</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">initial_infected</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39; patient zero recovered or dead with R0 = &#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">agent</span><span class="o">.</span><span class="n">others_infects_total</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_to_die&quot;</span><span class="p">][</span>
                                <span class="n">agent</span><span class="o">.</span><span class="n">age_group</span><span class="p">]</span> <span class="o">*</span> <span class="n">health_overburdened_multiplier</span><span class="p">):</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
                        <span class="n">critical</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="n">dead</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                        <span class="n">critical</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                        <span class="n">recovered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">days_recovered</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;probability_susceptible&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">agent</span><span class="o">.</span><span class="n">days_recovered</span><span class="p">):</span>
                    <span class="n">recovered</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
                    <span class="n">susceptible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="n">compliance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">compliance</span><span class="p">)</span>

        <span class="c1"># New infections</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
                <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">initial_infections</span><span class="p">[</span><span class="s1">&#39;Cases&#39;</span><span class="p">]]</span>
                <span class="n">probabilities_second_infection_district</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span>
                <span class="c1"># select districts with probability</span>
                <span class="n">chosen_districts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">districts</span><span class="p">,</span>
                                                        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">],</span>
                                                        <span class="n">p</span><span class="o">=</span><span class="n">probabilities_second_infection_district</span><span class="p">))</span>
                <span class="c1"># count how often a district is in that list</span>
                <span class="n">chosen_districts</span> <span class="o">=</span> <span class="p">{</span><span class="n">distr</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">distr</span><span class="p">]),</span>
                                              <span class="n">chosen_districts</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distr</span><span class="p">))</span> <span class="k">for</span> <span class="n">distr</span> <span class="ow">in</span> <span class="n">chosen_districts</span><span class="p">}</span>

            <span class="k">elif</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">initial_infections</span><span class="p">[</span><span class="s1">&#39;Cases&#39;</span><span class="p">]]</span>
                <span class="n">probabilities_second_infection_district</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span>
                <span class="c1"># select districts with probability</span>
                <span class="n">chosen_districts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">districts</span><span class="p">,</span>
                                                        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">],</span>
                                                        <span class="n">p</span><span class="o">=</span><span class="n">probabilities_second_infection_district</span><span class="p">))</span>
                <span class="c1"># count how often a district is in that list</span>
                <span class="n">chosen_districts</span> <span class="o">=</span> <span class="p">{</span><span class="n">distr</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">distr</span><span class="p">]),</span>
                                              <span class="n">chosen_districts</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distr</span><span class="p">))</span> <span class="k">for</span> <span class="n">distr</span> <span class="ow">in</span> <span class="n">chosen_districts</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chosen_districts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">district</span> <span class="ow">in</span> <span class="n">chosen_districts</span><span class="p">:</span>
                <span class="c1"># infect appropriate number of random agents</span>
                <span class="n">chosen_agents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">district_agents</span><span class="p">[</span><span class="n">district</span><span class="p">],</span> <span class="n">chosen_districts</span><span class="p">[</span><span class="n">district</span><span class="p">],</span>
                                                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">chosen_agent</span> <span class="ow">in</span> <span class="n">chosen_agents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">chosen_agent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                         <span class="n">new_status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
                        <span class="n">chosen_agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
                        <span class="k">if</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
                            <span class="n">chosen_agent</span><span class="o">.</span><span class="n">incubation_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;exposed_days&#39;</span><span class="p">])</span>
                            <span class="n">exposed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;i1&#39;</span><span class="p">:</span>
                            <span class="n">chosen_agent</span><span class="o">.</span><span class="n">asymptomatic_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                                                              <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;asymptom_days&#39;</span><span class="p">])</span>
                            <span class="n">sick_without_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;i2&#39;</span><span class="p">:</span>
                            <span class="n">chosen_agent</span><span class="o">.</span><span class="n">sick_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;symptom_days&#39;</span><span class="p">])</span>
                            <span class="n">sick_with_symptoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>

                        <span class="n">susceptible</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">chosen_agent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_output</span> <span class="o">==</span> <span class="s1">&#39;network&#39;</span><span class="p">:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">infection_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">store_network</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">data_output</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">write_status_location</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_output</span> <span class="o">==</span> <span class="s1">&#39;csv-light&#39;</span><span class="p">:</span>
            <span class="c1"># save only the total quantity of agents per category</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
                                    <span class="p">[</span><span class="n">exposed</span><span class="p">,</span> <span class="n">susceptible</span><span class="p">,</span> <span class="n">sick_without_symptoms</span><span class="p">,</span> <span class="n">sick_with_symptoms</span><span class="p">,</span>
                                      <span class="n">critical</span><span class="p">,</span> <span class="n">recovered</span><span class="p">,</span> <span class="n">dead</span><span class="p">]):</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">infection_quantities</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">infection_quantities</span><span class="p">[</span><span class="s1">&#39;compliance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">compliance</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">environment</span>
</pre></div>
</div>
</div>
<div class="section" id="updater">
<h2>Updater<a class="headerlink" href="#updater" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="kn">from</span> <span class="nn">sabcom.runner</span> <span class="kn">import</span> <span class="n">runner</span>
<span class="kn">from</span> <span class="nn">sabcom.helpers</span> <span class="kn">import</span> <span class="n">generate_district_data</span><span class="p">,</span> <span class="n">what_informality</span>


<span class="k">def</span> <span class="nf">updater</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># store often used arguments in temporary variable</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">)</span>
    <span class="n">output_folder_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_folder_path&#39;</span><span class="p">)</span>
    <span class="n">input_folder_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_folder_path&#39;</span><span class="p">)</span>

    <span class="c1"># formulate paths to initialisation folder and seed within input folder</span>
    <span class="n">inititialisation_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s1">&#39;initialisations&#39;</span><span class="p">)</span>
    <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inititialisation_path</span><span class="p">,</span> <span class="s1">&#39;seed_</span><span class="si">{}</span><span class="s1">.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">seed_path</span><span class="p">):</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">seed_path</span> <span class="o">+</span> <span class="s1">&#39; not found&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Error: specify a valid seed&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># open the seed pickle object as an environment</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">seed_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">list_of_objects</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="n">list_of_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># initialise logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span>
                                              <span class="s1">&#39;simulation_seed</span><span class="si">{}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">)),</span> <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start of simulation seed</span><span class="si">{}</span><span class="s1"> with arguments -i =</span><span class="si">{}</span><span class="s1">, -o=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>
                                                                                  <span class="n">input_folder_path</span><span class="p">,</span>
                                                                                  <span class="n">output_folder_path</span><span class="p">))</span>

    <span class="c1"># update optional parameters</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sensitivity_config_file_path&#39;</span><span class="p">):</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sensitivity_config_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">config_path</span> <span class="o">+</span> <span class="s1">&#39; not found&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Error: specify a valid path to the sensitivity config file&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
                    <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Time has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Time has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
        <span class="c1"># ensure that stringency is never shorter than time if time length is increased</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">+=</span> <span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">),</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;The stringency index has been lenghtened by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s1">&#39;Transmission probability has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Transmission probability has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;probability_transmission&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s1">&#39;Second infection number has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Second infection number has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;second_infection_n&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s1">&#39;Second infection time has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Second infection time has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time_4_new_infections&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s1">&#39;New infections scenario has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;New infections scenario has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_infections_scenario&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])]</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Recurring contacts has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Recurring contacts has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">]),</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;visiting_recurring_contacts_multiplier has been lengthened by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Likelihood awareness has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Likelihood awareness has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Max contacts has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Max contacts has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_infections&#39;</span><span class="p">):</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;total_initial_infections&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_infections&#39;</span><span class="p">)))</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Initial infections have been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;total_initial_infections&#39;</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Initial infections have been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;total_initial_infections&#39;</span><span class="p">]))</span>

    <span class="c1"># check if the stringency index has changed in the parameter file</span>
    <span class="n">sringency_index_updated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">!=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">]:</span>
        <span class="c1"># initialise stochastic process in case stringency index has changed</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;change in stringency index detected and updated for all agents&#39;</span><span class="p">)</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">stringency_index</span> <span class="o">+=</span> <span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">]),</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])]</span>

        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> \
                      <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;private_shock_stdev&#39;</span><span class="p">]</span>
        <span class="n">shocks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">lower</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">))</span>
        <span class="n">sringency_index_updated</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># transform input data to general district data for simulations</span>
    <span class="n">district_data</span> <span class="o">=</span> <span class="n">generate_district_data</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;number_of_agents&#39;</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">input_folder_path</span><span class="p">)</span>

    <span class="c1"># set scenario specific parameters</span>
    <span class="n">scenario</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;no-intervention&#39;</span><span class="p">)</span>  <span class="c1"># if no input was provided use no-intervention</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;scenario is </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s1">&#39;no-intervention&#39;</span><span class="p">:</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;likelihood_awareness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">1.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;visiting_recurring_contacts_multiplier&#39;</span><span class="p">]]</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gathering_max_contacts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;physical_distancing_multiplier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;informality_dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s1">&#39;lockdown&#39;</span><span class="p">:</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;informality_dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s1">&#39;ineffective-lockdown&#39;</span><span class="p">:</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;informality_dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># log parameters used after scenario called</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">{}</span><span class="s1"> has the value </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>

    <span class="c1"># update agent informality based on scenario</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">informality</span> <span class="o">=</span> <span class="n">what_informality</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">district</span><span class="p">,</span> <span class="n">district_data</span>
                                            <span class="p">)</span> <span class="o">*</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;informality_dummy&quot;</span><span class="p">]</span>
        <span class="c1"># optionally also update agent initial compliance if stringency was changed.</span>
        <span class="k">if</span> <span class="n">sringency_index_updated</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stringency_index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">shocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">previous_compliance</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">compliance</span>

    <span class="n">initial_infections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="s1">&#39;f_initial_cases.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;data_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_output_mode&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;csv-light&#39;</span><span class="p">)</span>  <span class="c1"># default output mode is csv_light</span>

    <span class="c1"># Simulate the model</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="n">runner</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">environment</span><span class="p">,</span> <span class="n">initial_infections</span><span class="o">=</span><span class="n">initial_infections</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span>
                        <span class="n">data_folder</span><span class="o">=</span><span class="n">output_folder_path</span><span class="p">,</span>
                        <span class="n">data_output</span><span class="o">=</span><span class="n">environment</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;data_output&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">environment</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="feedback.html" class="btn btn-neutral float-right" title="Feedback" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Joeri Schasfoort

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>